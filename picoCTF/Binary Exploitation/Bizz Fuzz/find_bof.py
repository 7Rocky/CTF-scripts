#!/usr/bin/env python3

import re


def main():
    with open('vuln.c') as f:
        all_lines = f.read().splitlines()

    lines = []

    for i, line in enumerate(all_lines):
        if line.startswith('  char local_') or 'fgets(local_' in line:
            lines.append((i, line.strip()))

    print('Parsed lines. Total:', len(lines), '/', len(all_lines))
    i = 0

    while i < len(lines):
        n, line = lines[i]

        if 'char local' in line:
            buffer = int(re.findall(r'char local_.. \[(\d+?)\];', line)[0])
            i += 1

            _, next_line = lines[i]

            while 'fgets(local' in next_line and i < len(lines):
                used_buffer_str = re.findall(
                    r'fgets\(local_..,([x0-9a-f]+?),.*?\);', next_line)[0]

                used_buffer = int(
                    used_buffer_str, 16 if 'x' in used_buffer_str else 10)

                if used_buffer > buffer:
                    print('Reserved:', buffer, 'B. Used:', used_buffer, 'B')  
                    print('Function name:', all_lines[n - 3])

                i += 1

                if i < len(lines):
                    _, next_line = lines[i]


if __name__ == '__main__':
    main()
